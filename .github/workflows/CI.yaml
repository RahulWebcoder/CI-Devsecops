
name: CI Pipeline (Tests, SonarQube Server, Trivy)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

# NOTE: Only needed if you later upload SARIF to Code Scanning.
# permissions:
#   contents: read
#   security-events: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout
      - name: Checkout code
        uses: actions/checkout@v6

      # 2) Set up Python
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      # 3) Cache pip to speed up installs
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4) Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5) Run tests and capture output
      - name: Run tests
        run: |
          PYTHONPATH="$(pwd)" pytest -q | tee result.log
        shell: bash

      # 6) Upload test log as artifact
      - name: Upload test results
        uses: actions/upload-artifact@v6
        with:
          name: test-results
          path: result.log

      # 7) SonarQube scan (self-hosted server)
      #    The action reads sonar-project.properties in the repo root.
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}
          SONAR_HOST_URL: 'http://3.236.15.76:9000/'

      # 8) Trivy filesystem scan (source repo)
      - name: Run Trivy scan (fs)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'          # correct option for filesystem scanning
          scan-ref: '.'            # path to scan (repo root)
          format: 'table'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'           # set to '1' if you want the job to fail on findings

      # --- Optional: Generate and upload SARIF to GitHub Code Scanning ---
      # - name: Trivy SARIF
      #   uses: aquasecurity/trivy-action@0.33.1
      #   with:
      #     scan-type: 'fs'
      #     scan-ref: '.'
      #     format: 'sarif'
      #     output: 'trivy.sarif'
      #     severity: 'CRITICAL,HIGH'
      #     ignore-unfixed: true
      #
      # - name: Upload SARIF to GitHub Code Scanning
      #        #   uses: github/codeql-action/upload-sarif@v3
      #   with:
